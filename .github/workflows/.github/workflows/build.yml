name: Build Heisenberg'sDarkRealm Kernel (v4 - Final)

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel for Realme Note 50
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v4

      - name: Install Dependencies & Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y git bc bison flex build-essential libssl-dev libncurses-dev make
          git clone --depth=1 https://github.com/kdrag0n/proton-clang toolchain

      - name: Build Kernel
        run: |
          # Add the toolchain to the path
          export PATH="$PWD/toolchain/bin:$PATH"
          
          # Forcefully remove the setting that treats warnings as errors
          sed -i 's/-Werror//g' Makefile
          
          # Configure and build the kernel, logging all output
          make ARCH=arm64 O=out unisoc_fuzz_ums512_defconfig
          make -j$(nproc) ARCH=arm64 O=out CC=clang LD=ld.lld AR=llvm-ar NM=llvm-nm OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip 2>&1 | tee build.log

      - name: Prepare Kernel Image
        # This step only runs if the build step was successful
        if: success()
        run: |
          KIMG=out/arch/arm64/boot/Image.gz-dtb
          [ -f "$KIMG" ] || KIMG=out/arch/arm64/boot/Image
          mv "$KIMG" zImage
          ls -lh zImage

      - name: Upload Kernel Artifact (on Success)
        # This step only runs if the build step was successful
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: HeisenbergKernel-zImage
          path: zImage

      - name: Upload Full Build Log (on Failure)
        # This step ONLY runs if the build FAILED
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: full-build-log
          path: build.log
